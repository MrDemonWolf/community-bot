---
title: Architecture
description: Monorepo structure and shared packages.
---

Community Bot uses [Turborepo](https://turbo.build/repo) for monorepo management with pnpm workspaces.

## Workspace Layout

```
apps/
  discord/     Discord bot (discord.js v14, BullMQ, Express)
  twitch/      Twitch bot (@twurple/chat, Express)
  web/         Next.js web dashboard
  docs/        Fumadocs documentation site
packages/
  db/          Prisma schema + client (source of truth)
  env/         Zod-validated environment variables
  config/      Shared TypeScript configuration
  server/      Shared Express API server
  auth/        Authentication package (better-auth)
  api/         Shared tRPC API utilities
  events/      Redis Pub/Sub event bus
```

## Shared Packages

### `@community-bot/db`

The single source of truth for all database models. Contains the Prisma schema split across domain files in `packages/db/prisma/schema/`:

- `schema.prisma` — Generator and datasource config
- `auth.prisma` — User, Session, Account, Verification
- `discord.prisma` — DiscordGuild
- `twitch.prisma` — TwitchChannel, TwitchNotification, TwitchCredential, TwitchChatCommand, TwitchRegular
- `queue.prisma` — QueueEntry, QueueState
- `audit.prisma` — AuditLog
- `system.prisma` — SystemConfig (key-value runtime config)

### `@community-bot/env`

Zod-validated environment variables using `@t3-oss/env-core`. Each app has its own env config:

- `packages/env/src/discord.ts` — Discord bot env
- `packages/env/src/twitch.ts` — Twitch bot env
- `packages/env/src/server.ts` — Web dashboard server env
- `packages/env/src/web.ts` — Web dashboard client env

### `@community-bot/server`

Shared Express API server configuration used by both bots. Provides:

- `createApiServer(options)` — Creates a configured Express app with helmet, cors, morgan, and health check middleware
- `listenWithFallback(app, options)` — Starts the server with automatic port fallback on EADDRINUSE

### `@community-bot/api`

Shared tRPC API routers and utilities consumed by the web dashboard. Includes:

- tRPC routers: `auditLog`, `discordGuild`, `botChannel`, `chatCommand`, `regular`, `user`, `setup`
- `logAudit()` utility (`packages/api/src/utils/audit.ts`) for recording all mutations to the audit log
- `discordFetch()` helper (`packages/api/src/utils/discord.ts`) for calling Discord REST API v10 with the bot token (used to fetch guild channels and roles for the web dashboard)

### `@community-bot/events`

Type-safe Redis Pub/Sub event bus for real-time inter-service communication. Uses two Redis connections (one for publishing, one for subscribing) to avoid blocking. All three services use it to stay in sync:

- **Web dashboard** publishes events when settings change (command CRUD, channel join/leave, Discord config)
- **Twitch bot** subscribes to reload commands, regulars, and channel list in real-time; publishes stream online/offline events
- **Discord bot** subscribes to stream events for live notifications and settings changes

See `packages/events/src/types.ts` for the full event registry.

### `@community-bot/config`

Shared TypeScript configuration. All packages extend `tsconfig.base.json`.

## Inter-Service Communication

The services communicate exclusively through the EventBus (Redis Pub/Sub) and the shared PostgreSQL database. There are no direct HTTP calls between services.

When a user changes a setting in the web dashboard, the flow is:
1. tRPC mutation updates the database
2. Mutation publishes an event to the EventBus
3. The relevant bot receives the event and reloads its in-memory cache

As a fallback, the Twitch bot also reloads its caches every 5 minutes via cron, so changes are eventually consistent even if an event is missed.

## TypeScript

Both bots use ESM (`"type": "module"`) with bundler module resolution. All relative imports require `.js` extensions. Both tsconfigs extend `@community-bot/config/tsconfig.base.json`.

## Turbo Tasks

| Task | Description |
|------|-------------|
| `pnpm dev` | Start all apps in dev mode |
| `pnpm build` | Build all packages and apps |
| `pnpm db:generate` | Generate Prisma client |
| `pnpm db:push` | Push schema to database |
| `pnpm db:migrate` | Run database migrations |
| `pnpm db:studio` | Open Prisma Studio |
